<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboards - ATIVA</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .menu-abas {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            border-bottom: 3px solid rgba(16, 185, 129, 0.2);
            padding-bottom: 15px;
        }
        
        .aba-btn {
            padding: 12px 24px;
            background: transparent;
            color: #10b981;
            border: 2px solid #10b981;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .aba-btn:hover {
            background: rgba(16, 185, 129, 0.1);
        }
        
        .aba-btn.ativo {
            background: #10b981;
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-sair {
            background: #ef4444;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }
        
        .btn-sair:hover {
            background: #dc2626;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1e2736 0%, #232d3d 100%);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid rgba(16, 185, 129, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .stat-card:hover {
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 0 12px 48px rgba(16, 185, 129, 0.2);
            transform: translateY(-5px);
        }
        
        .stat-label {
            color: #9ca3af;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-valor {
            color: #10b981;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }
        
        .grafico-container {
            background: linear-gradient(135deg, #1e2736 0%, #232d3d 100%);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid rgba(16, 185, 129, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .grafico-container:hover {
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 12px 48px rgba(16, 185, 129, 0.15);
        }
        
        .grafico-titulo {
            color: #10b981;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
        }
        
        .grafico-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1400px) {
            .grafico-row {
                grid-template-columns: 1fr;
            }
        }
        
        .dados-vazios {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .dados-vazios-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .plotly {
            background: transparent !important;
        }
        
        /* Customiza√ß√£o do Plotly */
        .plotly {
            color: #e0e0e0 !important;
        }
        
        .filtro-clientes {
            background: linear-gradient(135deg, #1e2736 0%, #232d3d 100%);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid rgba(16, 185, 129, 0.2);
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .filtro-clientes label {
            color: #10b981;
            font-weight: 600;
            margin-bottom: 12px;
            display: block;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        .filtro-clientes select {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            background: #0f1419;
            color: #e0e0e0;
            border: 2px solid #10b981;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filtro-clientes select:hover {
            border-color: #fbbf24;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.3);
        }
        
        .filtro-clientes select:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 16px rgba(251, 191, 36, 0.4);
            background: #141820;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo-container">
        <img src="/static/logo_distribuidora.png" alt="Logo ATIVA">
    </div>
    
    <!-- Menu de Abas -->
    <div class="menu-abas">
        <a href="/registros" class="aba-btn">üìã Registros</a>
        <button class="aba-btn ativo">üìä Dashboards</button>
        <a href="/logout" class="btn-sair">üö™ Sair</a>
    </div>
    
    <div class="dashboard-header">
        <h1>üìä Dashboards de An√°lise</h1>
    </div>
    
    <div id="conteudo-vazio" class="dados-vazios" style="display: none;">
        <div class="dados-vazios-icon">üì≠</div>
        <p style="font-size: 18px; margin-bottom: 10px;">Nenhum pedido registrado</p>
        <p style="font-size: 14px;">Os gr√°ficos aparecer√£o aqui quando houver pedidos no sistema</p>
    </div>
    
    <div id="conteudo-dashboards" style="display: none;">
        <!-- Filtro de Clientes -->
        <div class="filtro-clientes">
            <label for="filtro-cliente-select">üîç Filtrar por Cliente:</label>
            <select id="filtro-cliente-select" onchange="atualizarGraficos()">
                <option value="">üìä Todos os Clientes (Top 10)</option>
            </select>
        </div>
        
        <!-- Cards de Estat√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">üí∞ Total de Vendas</div>
                <div class="stat-valor" id="total-vendas">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üì¶ Total de Pedidos</div>
                <div class="stat-valor" id="total-pedidos">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üìä Ticket M√©dio</div>
                <div class="stat-valor" id="ticket-medio">R$ 0,00</div>
            </div>
        </div>
        
        <!-- Gr√°ficos -->
        <div class="grafico-row">
            <div class="grafico-container">
                <div class="grafico-titulo">üõçÔ∏è Produtos Mais Vendidos</div>
                <div id="grafico-produtos"></div>
            </div>
            <div class="grafico-container">
                <div class="grafico-titulo">üë• Clientes Top</div>
                <div id="grafico-clientes"></div>
            </div>
        </div>
        
        <div class="grafico-row">
            <div class="grafico-container">
                <div class="grafico-titulo">üìà Vendas por Data</div>
                <div id="grafico-datas"></div>
            </div>
            <div class="grafico-container">
                <div class="grafico-titulo">üí≥ Valores por Cliente</div>
                <div id="grafico-valores-cliente"></div>
            </div>
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
        <a href="http://localhost:5001/registros" style="color: #10b981; text-decoration: none; font-weight: 600;">‚Üê Voltar aos Registros</a>
    </div>
</div>

<script>
    // Dados dos gr√°ficos
    const dadosGraficos = {{ dados_graficos | safe }};
    let clienteSelecionado = '';
    
    // Configura√ß√£o Plotly para tema escuro
    const layoutBase = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(30, 39, 54, 0.3)',
        font: {
            color: '#e0e0e0',
            family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
            size: 12
        },
        margin: { l: 60, r: 30, t: 40, b: 60 },
        hovermode: 'closest',
        showlegend: true,
        legend: {
            bgcolor: 'rgba(15, 20, 25, 0.8)',
            bordercolor: 'rgba(16, 185, 129, 0.2)',
            borderwidth: 1,
            font: { size: 12 }
        }
    };
    
    // Configura√ß√£o responsiva
    const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        toImageButtonOptions: {
            format: 'png',
            filename: 'grafico_dashboard',
            height: 600,
            width: 800,
            scale: 2
        }
    };
    
    function montarSelectClientes() {
        const select = document.getElementById('filtro-cliente-select');
        const clientes = Object.keys(dadosGraficos.valores_por_cliente);
        
        // Limpar op√ß√µes existentes exceto a primeira
        while (select.options.length > 1) {
            select.remove(1);
        }
        
        // Adicionar clientes
        clientes.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente;
            option.textContent = cliente;
            select.appendChild(option);
        });
    }
    
    function filtrarDadosPorCliente(cliente) {
        if (cliente === '') {
            return dadosGraficos;
        }
        
        // Se um cliente espec√≠fico for selecionado, mostrar seus dados
        return {
            ...dadosGraficos,
            clientes_top: { [cliente]: 1 },
            valores_por_cliente: { [cliente]: dadosGraficos.valores_por_cliente[cliente] || 0 }
        };
    }
    
    function atualizarGraficos() {
        clienteSelecionado = document.getElementById('filtro-cliente-select').value;
        const dados = filtrarDadosPorCliente(clienteSelecionado);
        
        // Atualizar estat√≠sticas
        if (clienteSelecionado === '') {
            document.getElementById('total-vendas').textContent = 
                'R$ ' + dados.total_vendas.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('total-pedidos').textContent = dados.total_pedidos;
            document.getElementById('ticket-medio').textContent = 
                'R$ ' + dados.valor_medio.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        } else {
            const valorCliente = dados.valores_por_cliente[clienteSelecionado] || 0;
            const pedidosCliente = dadosGraficos.clientes_top[clienteSelecionado] || 0;
            
            document.getElementById('total-vendas').textContent = 
                'R$ ' + valorCliente.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('total-pedidos').textContent = pedidosCliente;
            document.getElementById('ticket-medio').textContent = 
                pedidosCliente > 0 ? 'R$ ' + (valorCliente / pedidosCliente).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 'R$ 0,00';
        }
        
        desenharGraficos(dados);
    }
    
    function desenharGraficos(dados) {
        // Gr√°fico de Produtos Mais Vendidos
        const produtosLabels = Object.keys(dados.produtos_vendidos).slice(0, 10);
        const produtosValores = Object.values(dados.produtos_vendidos).slice(0, 10);
        
        const graficoProdutos = {
            x: produtosValores,
            y: produtosLabels,
            type: 'bar',
            orientation: 'h',
            marker: {
                color: 'rgba(16, 185, 129, 0.8)',
                line: {
                    color: 'rgba(16, 185, 129, 1)',
                    width: 1
                }
            },
            hovertemplate: '<b>%{y}</b><br>Quantidade: %{x} unidades<extra></extra>',
            hoverinfo: 'all'
        };
        
        Plotly.newPlot('grafico-produtos', [graficoProdutos], 
            {...layoutBase, title: '', margin: { l: 200, r: 30, t: 40, b: 60 }}, 
            config);
        
        // Gr√°fico de Clientes Top
        const clientesLabels = Object.keys(dados.clientes_top).slice(0, 10);
        const clientesValores = Object.values(dados.clientes_top).slice(0, 10);
        
        const graficoClientes = {
            labels: clientesLabels,
            values: clientesValores,
            type: 'pie',
            marker: {
                colors: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(5, 150, 105, 1)',
                    'rgba(4, 120, 87, 1)',
                    'rgba(251, 191, 36, 1)',
                    'rgba(217, 119, 6, 1)',
                    'rgba(180, 83, 9, 1)',
                    'rgba(107, 114, 128, 1)',
                    'rgba(75, 85, 99, 1)',
                    'rgba(31, 41, 55, 1)',
                    'rgba(55, 65, 81, 1)'
                ]
            },
            textposition: 'inside',
            textinfo: 'label+percent',
            hovertemplate: '<b>%{label}</b><br>Pedidos: %{value}<br>Percentual: %{percent}<extra></extra>'
        };
        
        Plotly.newPlot('grafico-clientes', [graficoClientes], 
            {...layoutBase, title: ''}, 
            config);
        
        // Gr√°fico de Vendas por Data
        const datasLabels = Object.keys(dados.valores_por_data);
        const datasValores = Object.values(dados.valores_por_data);
        
        const graficoDatas = {
            x: datasLabels,
            y: datasValores,
            type: 'scatter',
            mode: 'lines+markers',
            fill: 'tozeroy',
            name: 'Vendas',
            line: {
                color: 'rgba(16, 185, 129, 1)',
                width: 3,
                shape: 'spline'
            },
            marker: {
                size: 10,
                color: 'rgba(251, 191, 36, 1)',
                line: {
                    color: 'rgba(16, 185, 129, 1)',
                    width: 2
                },
                symbol: 'diamond'
            },
            fillcolor: 'rgba(16, 185, 129, 0.2)',
            hovertemplate: '<b>Data: %{x}</b><br>Valor: R$ %{y:.2f}<br><extra></extra>'
        };
        
        Plotly.newPlot('grafico-datas', [graficoDatas], 
            {...layoutBase, title: '', xaxis: {title: 'Data do Pedido'}, yaxis: {title: 'Valor (R$)'}}, 
            config);
        
        // Gr√°fico de Valores por Cliente
        const valoresClienteLabels = Object.keys(dados.valores_por_cliente).slice(0, 10);
        const valoresClienteValores = Object.values(dados.valores_por_cliente).slice(0, 10);
        
        const graficoValoresCliente = {
            x: valoresClienteLabels,
            y: valoresClienteValores,
            type: 'bar',
            marker: {
                color: 'rgba(251, 191, 36, 0.8)',
                line: {
                    color: 'rgba(251, 191, 36, 1)',
                    width: 1
                }
            },
            hovertemplate: '<b>%{x}</b><br>Valor Total: R$ %{y:.2f}<br><extra></extra>'
        };
        
        Plotly.newPlot('grafico-valores-cliente', [graficoValoresCliente], 
            {...layoutBase, title: '', xaxis: {title: 'Cliente'}, yaxis: {title: 'Valor Total (R$)'}}, 
            config);
    }
    
    function mostrarDashboards() {
        if (dadosGraficos.total_pedidos === 0) {
            document.getElementById('conteudo-vazio').style.display = 'block';
            document.getElementById('conteudo-dashboards').style.display = 'none';
            return;
        }
        
        document.getElementById('conteudo-vazio').style.display = 'none';
        document.getElementById('conteudo-dashboards').style.display = 'block';
        
        // Montar select de clientes
        montarSelectClientes();
        
        // Atualizar gr√°ficos
        atualizarGraficos();
    }
    
    // Exibir dashboards ao carregar
    window.addEventListener('load', mostrarDashboards);
    
    // Responsividade dos gr√°ficos
    window.addEventListener('resize', () => {
        Plotly.Plots.resize('grafico-produtos');
        Plotly.Plots.resize('grafico-clientes');
        Plotly.Plots.resize('grafico-datas');
        Plotly.Plots.resize('grafico-valores-cliente');
    });
</script>
</body>
</html>
